. /usr/share/doc/tmux/examples/bash_completion_tmux.sh
complete -r tmux

_num_tmux_sessions() {
    tmux ls 2>/dev/null | wc -l
    return 0
}

_tmux_sessions() {
    local sessions=( "$(tmux ls -F '#{session_name}' 2>/dev/null)" )
    COMPREPLY=( ${COMPREPLY[@]:-} $(compgen -W "${sessions[*]}" -- $1) )
}

_num_tmux_clients() {
    tmux lsc 2>/dev/null | wc -l
    return 0
}

_tmux_clients() {
    local clients=( "$(tmux lsc -F '#{client_tty}' 2>/dev/null)" )
    COMPREPLY=( ${COMPREPLY[@]:-} $(compgen -W "${clients[*]}" -- $1) )
}

_num_tmux_windows() {
    tmux lsw 2>/dev/null | wc -l
    return 0
}

_tmux_windows() {
    local clients=( "$(tmux lsw -a -F '#{window_id}' 2>/dev/null)" )
    COMPREPLY=( ${COMPREPLY[@]:-} $(compgen -W "${clients[*]}" -- $1) )
}

_tmux_client_format() {
    local format_names=( "activity" "activity_string" "created"\
        "created_string" "cwd" "height" "last_session" "prefix"\
        "readonly" "session" "termname" "tty" "utf8" "width" )
    local suggestions=()
    local name
    for name in "${format_names[@]}"; do
        # Escape quotations for compgen.
        suggestions+=( "\\\"#{client_${name}}\\\"" )
    done

    # Escape quotation in $cur for compgen.
    local cur=$1
    if [ "${cur:0:1}" == "\"" ]; then
      cur="\\$cur"
    fi

    COMPREPLY=( ${COMPREPLY[@]:-} $(compgen -W "${suggestions[*]}" -- $cur) )
}

# Creates an extglob which must match $1, but additionally any letters found in
# sequence from $2.
_prefix() {
    local glob=$1
    local closing_parens=""

    local i
    for ((i=0; $i < ${#2}; i++)); do
        glob+="?(${2:$i:1}"
        closing_parens+=")"
    done

    echo ${glob}${closing_parens}
}

_better_tmux() {
    local cur=${COMP_WORDS[COMP_CWORD]}
    local prev=${COMP_WORDS[COMP_CWORD-1]}

    echo $cur

    # What has the user already typed?
    local cmd
    local enabled_opts=()

    # What options can we suggest?
    local options=()

    # Figure out what our command is.
    local i
    # Start at i=1 so we can skip tmux.
    for ((i=1; $i<$COMP_CWORD; i++)); do
        local word=${COMP_WORDS[i]}

        if [ "$word" == "-c" ]\
            || [ "$word" == "-f" ]\
            || [ "$word" == "-L" ]\
            || [ "$word" == "-S" ]; then
            # These tmux options take a parameter. Skip the parameter.
            ((i++))
        elif [[ "$word" == -* ]]; then
            :
            # Skip this option, we don't care.
        else
            cmd="$word"
            break
        fi
    done

    # Figure out what options have already been enabled.
    for ((; $i<$COMP_CWORD; i++)); do
        local word=${COMP_WORDS[i]}

        if [[ "$word" == -* ]]; then
            enabled_opts+=( "$word" )
        fi
    done

    # There is no command yet.
    if [ -z "$cmd" ]; then
        if ! tmux ls &>/dev/null; then
            # There are no existing sessions.

            # Commands that can be run with no existing session.
            local initial_commands=( "start-server" "new-session" )
            COMPREPLY=( $(compgen -W "${initial_commands[*]}" -- $cur) )
        else
            # Let the default tmux completer suggest commands.
            _tmux "$@"
        fi
        return 0
    fi

    local old_extglob=$(shopt -p extglob)
    shopt -s extglob
    case "$cmd" in
        $(_prefix a ttach-session))
            case "$prev" in
                -t) _tmux_sessions "$cur" ;;
                *)
                    options=( -d -r )
                    [ "$(_num_tmux_sessions)" -gt "1" ] && options+=( -t )
                    ;;
            esac ;;
        $(_prefix det ach-client))
            case "$prev" in
                -s) _tmux_sessions "$cur" ;;
                -t) _tmux_clients "$cur" ;;
                *)
                    options=( -P -a -s )
                    [ "$(_num_tmux_clients)" -gt "1" ] && options+=( -t )
                    ;;
            esac ;;
        $(_prefix h as-session))
            case "$prev" in
                -t) _tmux_sessions "$cur" ;;
                *)
                    [ "$(_num_tmux_sessions)" -gt "1" ] && options+=( -t )
                    ;;
            esac ;;
        $(_prefix kill-ses sion))
            case "$prev" in
                -t) _tmux_sessions "$cur" ;;
                *)
                    options=( -a )
                    [ "$(_num_tmux_sessions)" -gt "1" ] && options+=( -t )
                    ;;
            esac ;;
        lsc|$(_prefix list-cl ients))
            case "$prev" in
                -t) _tmux_sessions "$cur" ;;
                -F) _tmux_client_format "$cur" ;;
                *)
                    options=( -F )
                    [ "$(_num_tmux_sessions)" -gt "1" ] && options+=( -t )
                    ;;
            esac ;;
    esac
    eval $old_extglob

    if [ "${#options[@]}" -gt "0" ]; then
        # Remove options that have already been enabled.
        local opt
        for opt in "${enabled_opts[@]}"; do
            remove_first "$opt" options
        done

        COMPREPLY=( ${COMPREPLY[@]:-} $(compgen -W "${options[*]}" -- $cur) )
    fi
}

complete -F _better_tmux tmux
