#!/usr/bin/env bash

set -euo pipefail
[[ $# -eq 0 ]] || (echo 1>&2 "This script does not take arguments." && exit 1)
[[ -n "${DEBUG:-}" ]] && set -x

branch_format='%(objectname:short)%(if)%(upstream)%(then)
%(upstream:short)%(end)'
mapfile -t branches < <(git branch --list --format "${branch_format}")

common_ancestor="$(git merge-base --octopus "${branches[@]}")"
num_omitted="$(git log --format="format:%h" "${common_ancestor}~5" | wc -l)"
(
log_format='format:%C(auto)%h%d - %ch %C(dim white)- %aE %ah%C(reset)
%s
'
git --no-pager log \
    --color=always \
    --format="${log_format}" \
    --graph \
    "${branches[@]}" \
    "^${common_ancestor}~5"
if [[ "${num_omitted}" -gt 0 ]]; then
    echo "|"
    echo "."
    echo "."
fi
) | "${PAGER:-less}" -RF
